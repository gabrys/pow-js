#!/bin/bash

set -exuo pipefail

tmpdir="$(mktemp -d)"
cd "$tmpdir"
mkdir mjs

cp /build/pow-runner.sh pow-runner.sh
cp /build/pow-runner.exe pow-runner.exe
cp /pow/lib.*.mjs mjs/
cp /pow/pow.*.mjs mjs/
cp /pow/pow.mjs mjs/

(
  cd mjs/
  zip ../pow-runner.sh *.mjs
  zip ../pow-runner.exe *.mjs
)

cp pow-runner.sh pow-linux
/bin/assimilate -e pow-linux

cp pow-runner.sh pow-macos
/bin/assimilate -m pow-macos

mkdir -p /dist/linux
mv -b pow-linux /dist/linux/pow

mkdir -p /dist/macos
mv -b pow-macos /dist/macos/pow

mkdir -p /dist/windows
mv -b pow-runner.exe /dist/windows/pow.exe

if [ -e /dist/gitmodules/pow-dist-darwin/pow ]; then
  cp /dist/macos/pow /dist/gitmodules/pow-dist-darwin/
fi

if [ -e /dist/gitmodules/pow-dist-linux/pow ]; then
  cp /dist/linux/pow /dist/gitmodules/pow-dist-linux/
fi

if [ -e /dist/gitmodules/pow-windows/pow.exe ]; then
  cp /dist/windows/pow.exe /dist/gitmodules/pow-windows/
fi
