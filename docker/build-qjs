#!/bin/bash

set -euo pipefail

demzify() {
  echo
  echo  ====================
  echo "deMZify now (run #$1)"
  list_mz_files || true
  echo  ====================
  echo

  echo 'exit 123' > /build/cosmopolitan/build/sanitycheck2
  sed s/MZqFpD/Ue6OCi/g -i $(find_com)
}

find_com() {
  find /build/cosmopolitan/ -name '*.com' -not -name qjs.com
}

has_mz_files() {
  grep -q MZqFpD $(find_com)
}

list_mz_files() {
  grep -l MZqFpD $(find_com)
}

make_qjs() {
  make -j6 o//third_party/quickjs/qjs.com
}

cd /build/cosmopolitan/
for i in {1..5}; do
  demzify $i
  make_qjs || true
  if ! has_mz_files; then
    break
  fi
done

make_qjs
cp o/third_party/quickjs/qjs.com "$1"

